{% extends "app/layout.html" %}

{% block content %}
{% load staticfiles %}
{% include "chat/chat.html" %}
<div id="LockBlackout" style="width:100%;height:100%;background-color:#000000;opacity: .2;position:fixed;z-index:103;display:none" onclick="HideDetails()"></div>
<div align="center" style="margin:auto" >
    {% include "app/event_select.html" %}  
    <div class="">
        <div id="divStatus" style="margin:auto;text-align:center;" class="timer-red"></div>
        <div class="pt-1">
            {% include "app/status_dots.html" %}  
        </div>
        <div id="divStartList"></div>
        
    </div>
</div>
{% endblock %}

{% block scripts %}
<script type="text/javascript">
    var Session = "{{session.id}}";
    var SessionName = "{{session}}";
    var Team= "{{team.id}}";
    var ev = "{{event_name}}";
    var token = "{{ csrf_token }}";
</script>
<script type="text/javascript">
    //const firebase = require("firebase");
    var datahold;
    var AthleteID = -1;
    var Status = "";
    var StartListChange = -1;

    var db = firebase.firestore();
    db.collection("sessions").doc(Session).collection("event_managers").doc(ev)
        .onSnapshot(function (doc) {
            UpdateStatus(doc);
        });
    SetupChatListener();

    
    function UpdateStatus(doc) {
        if (doc.data() != undefined) {
            console.log("Status: " + Status + " | " + doc.data().status);
            console.log("AthleteID: " + AthleteID + " | " + doc.data().athlete_id);
            if (AthleteID != doc.data().athlete_id || doc.data().start_list_change != StartListChange) {
                AthleteID = doc.data().athlete_id;
                StartListChange = doc.data().start_list_change;
                Status = doc.data().status;
                $("#divStartList").load("/athlete_start_list/" + ev + "/" + Team, function () {
                    SetStatus();
                });
            }
            else if (Status != doc.data().status) {
                Status = doc.data().status;
                SetStatus();
            }


            //$("#divStatus").html(doc.data().stream + " | " + doc.data().status);
        }
        else {
            StatusDotsRed();
            $("#divStatus").html("ROTATION NOT ON THIS EVENT").removeClass("timer-yellow").removeClass("timer-green").addClass("timer-red");
        }
    }

    function SetStatus() {
        if ($("#" + $("#hdnUpNext").val()).html() != undefined) {
            if (Status == "AD" || Status == "F" || Status == "RD") {
                StatusDotsRed();
                $("#divStatus").html("EVALUATION IN PROGRESS").removeClass("timer-yellow").removeClass("timer-green").addClass("timer-red");
                $("#" + $("#hdnUpNext").val()).removeClass("status-dot-yellow").removeClass("status-dot-green").addClass("status-dot-red");
            }
            else if (Status == "N") {
                StatusDotsYellow();
                $("#divStatus").html("GET READY").addClass("timer-yellow").removeClass("timer-green").removeClass("timer-red");
                $("#" + $("#hdnUpNext").val()).addClass("status-dot-yellow").removeClass("status-dot-green").removeClass("status-dot-red");
            }
            else if (Status == "S") {
                StatusDotsGreen();
                $("#divStatus").html("ROUTINE IN PROGRESS").removeClass("timer-yellow").addClass("timer-green").removeClass("timer-red");
                $("#" + $("#hdnUpNext").val()).removeClass("status-dot-yellow").addClass("status-dot-green").removeClass("status-dot-red");
            }
        }
        else {
            StatusDotsRed();
            $("#divStatus").html("ROTATION NOT ON THIS EVENT").removeClass("timer-yellow").removeClass("timer-green").addClass("timer-red");
        }
    }

    function SwapEvent(evIn) {
        window.location = "/coach/" + evIn;
    }

</script>
{% endblock %}
